#!/usr/bin/env bash
set -euo pipefail

echo "[post-create] Bootstrapping {{ workspace_name }}..."

# Ensure rclone is installed (guard for images without it baked in)
if ! command -v rclone &> /dev/null; then
    echo "[post-create] Installing rclone..."
    # Ensure unzip is available
    if ! command -v unzip &> /dev/null; then
        echo "[post-create] Installing unzip..."
        sudo apt-get update -qq && sudo apt-get install -y -qq unzip
    fi
    RCLONE_VERSION="1.68.2"
    cd /tmp
    curl -fsSL -o rclone.zip "https://downloads.rclone.org/v${RCLONE_VERSION}/rclone-v${RCLONE_VERSION}-linux-amd64.zip"
    unzip -q rclone.zip
    sudo cp "rclone-v${RCLONE_VERSION}-linux-amd64/rclone" /usr/local/bin/
    sudo chmod +x /usr/local/bin/rclone
    rm -rf rclone.zip "rclone-v${RCLONE_VERSION}-linux-amd64"
    echo "[post-create] Installed rclone: $(rclone version | head -1)"
fi

mise trust
mise install
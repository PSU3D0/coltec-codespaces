name: {{ env }}
version: 1.0.0
metadata:
  org: {{ org }}
  project: {{ project }}
  environment: {{ env }}
  description: Workspace for {{ org }}/{{ project }}
  tags:
    - {{ project_type }}
devcontainer:
  image:
    name: {{ image }}
  user: vscode
  workspace_folder: /workspace
  workspace_mount: source=${localWorkspaceFolder},target=/workspace,type=bind
  run_args:
    - --cap-add=SYS_PTRACE
    - --security-opt=seccomp=unconfined
  mounts:
    - source: {{ env }}-cache
      target: /home/vscode/.cache
      type: volume
    - source: {{ env }}-daemon-state
      target: /home/vscode/.local/share/coltec-daemon
      type: volume
  lifecycle:
    post_create:
      - ./.devcontainer/scripts/post-create.sh
    post_start:
      - ./.devcontainer/scripts/post-start.sh
  customizations:
    extensions:
      recommended:
        - ms-azuretools.vscode-docker
        - ms-vscode.remote-explorer
        {%- if project_type == "python" %}
        - ms-python.python
        {%- elif project_type == "node" %}
        - dbaeumer.vscode-eslint
        - esbenp.prettier-vscode
        {%- elif project_type == "rust" %}
        - rust-lang.rust-analyzer
        - tamasfe.even-better-toml
        {%- elif project_type == "monorepo" %}
        - ms-python.python
        - dbaeumer.vscode-eslint
        - rust-lang.rust-analyzer
        - tamasfe.even-better-toml
        {%- endif %}
    settings:
      values:
        terminal.integrated.defaultProfile.linux: zsh
        terminal.integrated.cwd: /workspace
        files.trimTrailingWhitespace: true
        editor.formatOnSave: true
persistence:
  enabled: {{ persistence_enabled | lower }}
  mode: replicated
  {%- if persistence_enabled %}
  default_remote: primary
  remotes:
    primary:
      type: s3
      bucket: ${RCLONE_BUCKET}
      options:
        provider: Cloudflare
        access_key_id: ${RCLONE_S3_ACCESS_KEY_ID}
        secret_access_key: ${RCLONE_S3_SECRET_ACCESS_KEY}
        endpoint: ${RCLONE_S3_ENDPOINT}
        region: auto
  sync:
    - name: workspace
      path: /workspace
      remote_path: workspaces/{{ org }}/{{ project }}/{{ env }}/workspace
      direction: bidirectional
      interval: 300
      priority: 1
    - name: claude-config
      path: /home/vscode/.claude
      remote_path: workspaces/{{ org }}/{{ project }}/{{ env }}/claude-config
      direction: bidirectional
      interval: 60
      priority: 2
  {%- endif %}
generated_at: "{{ '%Y-%m-%dT%H:%M:%SZ' | strftime }}"
